# Stripe Microservice


Microservice to configure a simple payment and a subscription plan on stripe, using Ubuntu, Nginx, Python, Flask and MongoDB.

## Requirements
  - Nginx installed
  - MongoDB installed
  - Python >= 2.7 
  - 2 Enpoints (to update subscription plan customer status)

## Functions

  - Create first setting by Form 
  - Simple Payment
  - Subscribe Customer
  

You can also:
  - Get Subcription Plan
  - Update Subcription Plan
  - Cancel Customer Subscription 

## Installation

#### MongoDB

Ubuntu MongoDB Installation

```sh
$sudo apt-get update
$sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 9DA31620334BD75D9DCB49F368818C72E52529D4
$echo "deb [ arch=amd64 ] https://repo.mongodb.org/apt/ubuntu bionic/mongodb-org/4.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb.list
$sudo apt update
$sudo apt install mongodb-org
$sudo systemctl start mongod 
$sudo systemctl enable mongod
```

Create Data Base

```sh
$mongo
$db.adminCommand( { listDatabases: 1 } )
$use micro-db
$db.createCollection("testcollection")
$exit
```

#### Microstripe

Microstripe requires [Python](https://www.python.org/) v2.7+ to run.

*Do a Fork of the project

Requirements installation and starting the server.

```sh
$ git clone https://github.com/youruser/microstripe.git
$ cd mircrostripe/app
$ pip install -r requirements.txt
```

If you have another MongoDB Credentials, you must change app/Settings/env.py file. To test the installation you can run the application with the following cammand:

```sh
$ python app.py
```

Verify that the aplication is running by navigating to your server address in your preferred browser.

```sh
127.0.0.1:7000
```

##### Install gunicorn

Ubuntu gunicorn installation

```sh
$pip install gunicorn
$ cd mircrostripe/app
$gunicorn app:app
ctrl + c to stop gunicorn
```
 

##### Create service for Nigix

Creating service file

```sh
$sudo nano /etc/systemd/system/microstripe.service
```

microstripe.service

```sh
[Unit]
Description = microstripe
After = network.target

[Service]
PermissionsStartOnly = true
PIDFile = /run/microstripe/microstripe.pid
User = ubuntu
Group = www-data
WorkingDirectory = /home/ubuntu/microstripe/app
ExecStartPre = /bin/mkdir /run/microstripe
ExecStartPre = /bin/chown -R ubuntu:www-data /run/microstripe
ExecStart = /usr/bin/env gunicorn app:app -b 0.0.0.0:7000 --pid /run/microstripe/microstripe.pid
ExecReload = /bin/kill -s HUP $MAINPID
ExecStop = /bin/kill -s TERM $MAINPID
ExecStopPost = /bin/rm -rf /run/microstripe
PrivateTmp = true

[Install]
WantedBy = multi-user.target
```

Changing microstripe.service permissions

```sh
sudo chmod 755 /etc/systemd/system/microstripe.service
sudo systemctl daemon-reload
sudo systemctl start microstripe
sudo systemctl status microstripe
```

#### Nginx

Ubuntu Nginx Installation

```sh
$sudo apt-get update && sudo apt-get upgrade -y
>>install first option
$sudo apt-get install nginx -y
$sudo systemctl start nginx
$sudo systemctl enable nginx
```

Configuring Nginx proxy for microstripe

```sh
$sudo cat /etc/nginx/sites-available/default
$sudo rm /etc/nginx/sites-available/default
$sudo nano /etc/nginx/sites-available/default
```

/default content

```sh
server {
  listen 80;
  server_name yourdomain.com www.yourdomain.com;
  location / {
    proxy_pass http://127.0.0.1:7000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_redirect off;
  }
}
```

Reload Nginx

```sh
sudo systemctl reload nginx
```

Verify that the aplication is running by navigating to your server address in your preferred browser.

```sh
yourdomain.com
```

If all works, you can see the next page

![alt text](https://raw.github.com/supereze/microstripe/master/form.png)

## Configuring

##### Create first setting by Form

To configure the service, you must fill the fields in the previous image. You must have 2 endpoints with the following structure:

For listening to a subscription:

```sh
PUT
http://somedomain.com/success
{
    “email”:”email@gmail.com”
}
```

For listening to a cancelation:
```sh
PUT
http://somedomain.com/cancel
{
    “email”:”email@gmail.com”
}
```

The next step is save the apiKey.  

![alt text](https://raw.github.com/supereze/microstripe/master/apiKey.png)

It so important saving that key, due to it is needed in next steps to do a simple payment or a custumer subscription.

## Payments and Subscription
### Simple Payment

You can use curl (php), axios(javascript), requests(python) to do a http request with the following requirements:
```sh
POST
http://yourdomain.com/simple-payment/5dcf662c94d7ca56c4057b8e
Pathparam apiKey:  /simple-payment/<apiKey>
{
    “email”:”email@gmail.com”,
    “stripeToken”:”asdasdasd”,
    “amount”: 2311, 
    “currency”:mxn,
    “description”:”Name of the product”
}
```

*Note: stripeToken is generated by the front end, [React example](https://stripe.com/docs/recipes/elements-react)

### Customer Subscription

##### Subscribe Customer 

```sh
POST
http://yourdomain.com/customer
{
    “email”:”email@gmail.com”,
    “token”:”asdad”, //token generado desde el front
    “apiKey”:”5dcf239c94d7ca56c4057b8e”,
    “name”:”Nombre Usuario”
}
```
*Note: token is generated by the front end, [React example](https://stripe.com/docs/recipes/elements-react)

##### Cancel Customer Subscription 

```sh
DELETE
http://yourdomain.com/customer?apikey=<apiKey>&email=<email>
Pathparam apiKey and email, example:
http://yourdomain.com/customer?apikey=sfsdfsdfsd&email=email@gmail.com
```

## Administrator interface methods

##### Get Subcription Plan

```sh
GET
http://yourdomain.com/plan/5dcf662c94d7ca56c4057b8e
Pathparam apiKey:  /plan/<apiKey>
```
Response

```sh

{"_id":"5dcf156394d7ca53e37c61c1",
"apiKey":"5dcf156394d7ca53e37c61c1",
"cancelWebhook":"http://somedomain.com/cancel",
"developKey":"sk_test_",
"email":"email@gmail.com",
"inProduction":true,
"productionKey":"sk_live_",
"project":"Some name",
"subPlanAmount":195.0,
"subPlanCurrency":"mxn",
"subPlanId":"plan_GBZG5R8buG9nxl",
"subPlanInterval":"month",
"subProductId":"prod_GBZG392QCF5Jvn",
"subProductName":"Plan Premium",
"successfulWebhook":"http://somedomain.com/success"}

```

##### Update Subcription Plan

```sh
PATCH
http://yourdomain.com/plan/5dcf662c94d7ca56c4057b8e
Pathparam apiKey:  /plan/<apiKey>
{
    productionKey:”productionKey”,
    developKey:”developKey”,
    inProduction:false  //or true
    successfulWebhook:”successfulWebhook”,
    cancelWebhoook:”cancelWebhoook”,
    subProductName:”subProductName”,
}

```

## Weebhook

You must add the following url to the stripe dashboard developers/webhooks:

```sh
http://yourdomain.com/webhook/<your apiKey>
```

Adding Webhook

![alt text](https://raw.github.com/supereze/microstripe/master/webhooks.png)

Added Webhook 
![alt text](https://raw.github.com/supereze/microstripe/master/webhooks2.png)

